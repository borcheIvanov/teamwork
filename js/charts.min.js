angular.module('charts', [])
.controller('statsCtrl', function($scope, $http, $rootScope, $location){

	if (localStorage['session'] == undefined){
		$location.path('/');
	}
	
	$scope.show = false;

	$scope.showUsers = function(){
		$scope.show = true;
	};

	$scope.arr1 = [];
	
	$scope.resetCount = function(){
		for(i = 0; i < 50; i++){
			$scope.arr1[i] = 0;
		}
	};
	
	$scope.resetCount();
	
	$rootScope.admin = false;
	
	$http({
		  method: 'get',
		  url: url + '/api/task',
		  params: {type: 'json'}
	}).success(function (response) {
		
		$scope.tasks = response;	
		
	}).error(function (err) {
		console.log(err);
	});	
	
	$http({
		  method: 'get',
		  url: url + '/api/user',
		  params: {type: 'json'}
	}).success(function (response) {
		
		$scope.users = response;
				for(i = 0; i < $scope.users.length; i++){
					if($scope.users[i].id == localStorage['session']){
						if($scope.users[i].email == 'admin@polarcape.com'){
							$rootScope.admin = true;
						}
					}
				}
				
	}).error(function (err) {
		console.log(err);
	});	
	
	$scope.statusArray = [];
	
	$http({
			  method: 'get',
			  url: url + '/api/status',
			  params: {type: 'json'}
			}).success(function (response) {
			  
				$scope.statusArray = response;
				
			}).error(function (err) {
			  console.log(err);
	});	
	
	
	
//-----------onClick----------------------------------------------------------

	$scope.status = function(){
		
		$scope.chartArray = [];
			$scope.chartPrint = [];
			
			for(i = 0; i < $scope.statusArray.length; i++){
				for(j = 0; j < $scope.tasks.length; j++){
					if($scope.tasks[j].status == $scope.statusArray[i].status){
						$scope.arr1[i]++;
						}
				}
				$scope.chartArray.push({'x': $scope.statusArray[i].status, 'y': [$scope.arr1[i]]});
			}
			

			$scope.chartArray.forEach(function(n) {
					
						$scope.chartPrint.push(n);
					});
		
		$scope.config = {
			title: 'by Status',
			tooltips: true,
			labels: false,
			legend: {
			  display: false,
			  position: 'right'
			}
		  };

		  $scope.data = {
				series: ['by Status'],
				data: $scope.chartPrint
			};
		  $scope.resetCount();
	};
	
	$scope.type = function(){
		
		for(i = 0; i < $scope.tasks.length; i++){
				
						if($scope.tasks[i].type == 'Feature'){
							$scope.arr1[5]++;
						}
						if($scope.tasks[i].type == 'Enhancement'){
							$scope.arr1[6]++;
						}
						if($scope.tasks[i].type == 'Bug'){
							$scope.arr1[7]++;
						}
						if($scope.tasks[i].type == 'Spike'){
							$scope.arr1[8]++;
						}
					}
					
			$scope.config = {
			title: 'by Type',
			tooltips: true,
			labels: false,
			legend: {
			  display: false,
			  position: 'right'
			}
		  };

		  $scope.data = {
			series: ['Type'],
			data: [{
			  x: "Feature",
			  y: [$scope.arr1[5]],
			}, {
			  x: "Enhancement",
			  y: [$scope.arr1[6]]
			}, {
			  x: "Bug",
			  y: [$scope.arr1[7]]
			},{
			  x: "Spike",
			  y: [$scope.arr1[8]]
			}]
		  };
		  $scope.resetCount();
	};
	
	$scope.overall = function(){
		
		for(i = 0; i < $scope.tasks.length; i++){

						if($scope.tasks[i].status != 'Closed'){
							$scope.arr1[9]++;
							$scope.arr1[11]++;
						}
						if($scope.tasks[i].status == 'Closed'){
							$scope.arr1[10]++;
							$scope.arr1[11]++;
						}
					}
		
		$scope.config = {
			title: 'Overall',
			tooltips: true,
			labels: false,
			legend: {
			  display: false,
			  position: 'right'
			}
		  };

		  $scope.data = {
			series: ['Overall'],
			data: [{
			  x: "Created",
			  y: [$scope.arr1[11]]
			}, {
			  x: "Working on",
			  y: [$scope.arr1[9]]
			}, {
			  x: "Closed",
			  y: [$scope.arr1[10]]
			}]
		  };
		$scope.resetCount();
	};
	
	$scope.showResults = function(){
		
		if($scope.selectedUser != 'all'){
			
			$scope.chartArray = [];
			$scope.chartPrint = [];
			
			for(i = 0; i < $scope.statusArray.length; i++){
				for(j = 0; j < $scope.tasks.length; j++){
					if($scope.tasks[j].status == $scope.statusArray[i].status && $scope.tasks[j].assignee.id == $scope.selectedUser){
						$scope.arr1[i]++;
						}
				}
				$scope.chartArray.push({'x': $scope.statusArray[i].status, 'y': [$scope.arr1[i]]});
			}
			

			$scope.chartArray.forEach(function(n) {
					
						$scope.chartPrint.push(n);
					});
			
			
		
			
		
			$scope.config = {
				title: 'by Status',
				tooltips: true,
				labels: false,
				legend: {
				  display: false,
				  position: 'right'
				}
			};

			$scope.data = {
				series: ['Tasks by user'],
				data: $scope.chartPrint
			};
				
		} else{
			
			$scope.chartArray = [];
			$scope.chartPrint = [];
			
			for(i = 0; i < $scope.users.length; i++){
				for(j = 0; j < $scope.tasks.length; j++){
					if($scope.tasks[j].assignee.id != undefined && $scope.users[i].id == $scope.tasks[j].assignee.id){
						$scope.arr1[i]++;
					}
				}
				$scope.chartArray.push({'x': $scope.users[i].name, 'y': [$scope.arr1[i]]});
			}
			

			$scope.chartArray.forEach(function(n) {
					
						$scope.chartPrint.push(n);
					});
			
			$scope.config = {
				title: 'Tasks by user',
				tooltips: true,
				labels: false,
				legend: {
				  display: false,
				  position: 'right'
				}
			};
			$scope.data = {
				series: ['Tasks by user'],
				data: $scope.chartPrint
			};
		}
		$scope.resetCount();
		
	};

})

